name: CD - Test

on:
  push:
    branches:
      - Test

jobs:
  deploy-test:
    name: Infrastructure Check & Deploy to Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # === Terraform Setup ===
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Terraform Init
        working-directory: infra/test
        run: terraform init -input=false

      - name: Terraform Validate
        working-directory: infra/test
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: infra/test
        run: terraform plan -input=false -no-color -out=tfplan.out

      - name: Check for infrastructure changes
        id: tf_changes
        working-directory: infra/test
        run: |
          terraform show -json tfplan.out | jq '.resource_changes | length' > changes.txt
          count=$(cat changes.txt)
          echo "Infrastructure changes detected: $count"
          if [ "$count" -gt 0 ]; then
            echo "apply_needed=true" >> $GITHUB_ENV
          else
            echo "apply_needed=false" >> $GITHUB_ENV
          fi

      # === Recreate infra en entorno de pruebas ===
      - name: Recreate Test Infrastructure (if needed)
        if: env.apply_needed == 'true'
        working-directory: infra/test
        run: |
          echo "‚ö†Ô∏è Detected infra changes ‚Äî recreating Test environment..."
          terraform destroy -auto-approve -input=false
          terraform apply -auto-approve -input=false

      # === Pull de im√°genes desde Dev ===
      - name: Pull Docker images from Dev
        run: |
          docker pull myregistry/stockwiz-api-gateway:dev || true
          docker pull myregistry/stockwiz-product-service:dev || true
          docker pull myregistry/stockwiz-inventory-service:dev || true

      # === Deploy a ECS/EKS Test Cluster ===
      - name: Deploy to ECS Test Cluster
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ecs/test-task-def.json
          service: stockwiz-test-service
          cluster: stockwiz-cluster
          wait-for-service-stability: true

      # === Tests funcionales ===
      - name: Run functional tests (Postman)
        run: |
          echo "‚öôÔ∏è Ejecutando pruebas funcionales..."
          newman run tests/postman_collection.json || true

      # === Tests de carga ===
      - name: Run performance tests (k6)
        run: |
          echo "üí£ Ejecutando pruebas de carga..."
          k6 run tests/performance.js || true

      # === Notificaci√≥n final ===
      - name: Notify success
        run: echo "‚úÖ Despliegue y validaciones completadas exitosamente en ambiente de Test."
